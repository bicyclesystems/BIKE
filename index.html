<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Bike</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="rene/index.css" />
    <!-- Use ESM directly in browser -->
    <script type="module">
      import * as Y from "https://cdn.skypack.dev/yjs@13.6.9";
      import { WebrtcProvider } from "https://cdn.skypack.dev/y-webrtc@10.0.10";

      window.Y = Y;
      window.WebrtcProvider = WebrtcProvider;

      console.log("Yjs loaded:", Y);
      console.log("WebrtcProvider loaded:", WebrtcProvider);
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
      // Configure PDF.js worker
      if (typeof pdfjsLib !== "undefined") {
        pdfjsLib.GlobalWorkerOptions.workerSrc =
          "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
      }
    </script>
  </head>

  <body
    class="view align-center justify-center"
    style="
      background-size: cover;
      background-position: center center;
      background-repeat: no-repeat;
      background-attachment: fixed;
    "
  >
    <script>
      // Add this before your view-welcome.js script
      window.yjsLoaded = new Promise((resolve) => {
        window.resolveYjsLoaded = resolve;
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="config.js"></script>
    <script src="memory.js"></script>
    <script src="sync.js"></script>
    <script src="actions.js"></script>
    <script src="context/context.js"></script>
    <script src="context/context-highlight.js"></script>
    <script src="user.js"></script>
    <script src="artifacts.js"></script>
    <script src="input.js"></script>
    <script src="process/process.js"></script>
    <script src="process/process-image.js"></script>
    <script src="process/process-content.js"></script>
    <script src="orchestrate.js"></script>
    <script src="messages.js"></script>
    <script src="views/view-artifact.js"></script>
    <script src="views/view-artifacts.js"></script>
    <script src="views/view-calendar.js"></script>
    <script src="views/view-memory.js"></script>
    <script src="views/view-services.js"></script>
    <script src="views/view-chat.js"></script>
    <script src="views/view-welcome.js" defer></script>
    <script src="views/views.js"></script>
    <script src="theme.js"></script>

    <script>
      // Simple, distributed initialization
      document.addEventListener("DOMContentLoaded", async function () {
        // Initialize authentication FIRST to determine user state
        const session = await user.initAuth();

        // Initialize context with knowledge of auth state (loads data appropriately)
        await context.init(session);

        // Handle UI based on auth state
        await user.updateAuthState(session);

        // Initialize modules (they handle their own click handlers and UI)
        artifacts.init();
        views.init();
      });
    </script>
    <script>
      function handleHashChange() {
        const hash = location.hash.replace(/^#\/?/, "");
        const parts = hash.split("/");

        if (parts.length === 3 && parts[2] === "live") {
          const userId = parts[0];
          const sessionId = parts[1].replace("live-", "");

          // Set active view for live session

          window.context?.setActiveView("live", {});
          window.views.renderCurrentView();
        }
      }
      // window.addEventListener("hashchange", handleHashChange);
      // window.addEventListener("load", handleHashChange);
    </script>
  </body>
</html>
