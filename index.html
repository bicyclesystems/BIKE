<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Bike</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="rene/index.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
      // Configure PDF.js worker
      if (typeof pdfjsLib !== "undefined") {
        pdfjsLib.GlobalWorkerOptions.workerSrc =
          "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
      }
    </script>
  </head>

  <body
    class="view align-center justify-center"
    style="
      background-size: cover;
      background-position: center center;
      background-repeat: no-repeat;
      background-attachment: fixed;
    "
  >
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Yjs and y-webrtc for real-time collaboration -->
    <script type="module">
      import * as Y from "https://cdn.skypack.dev/yjs@13.6.8";
      import { WebrtcProvider } from "https://cdn.skypack.dev/y-webrtc@10.2.5";

      window.Y = Y;
      window.WebrtcProvider = WebrtcProvider;

      console.log("âœ… Yjs loaded:", Y.VERSION);
      console.log("âœ… WebrtcProvider loaded");
    </script>

    <script src="config.js"></script>
    <script src="memory.js"></script>
    <script src="sync.js"></script>
    <script src="actions.js"></script>
    <script src="context/context.js"></script>
    <script src="context/context-highlight.js"></script>
    <script src="user.js"></script>
    <script src="artifacts.js"></script>
    <script src="input.js"></script>
    <script src="process/process.js"></script>
    <script src="process/process-image.js"></script>
    <script src="process/process-content.js"></script>
    <script src="orchestrate.js"></script>
    <script src="messages.js"></script>
    <script src="views/view-artifact.js"></script>
    <script src="views/view-artifacts.js"></script>
    <script src="views/view-calendar.js"></script>
    <script src="views/view-memory.js"></script>
    <script src="views/view-services.js"></script>
    <script src="views/view-chat.js"></script>
    <script src="views/views.js"></script>
    <script src="theme.js"></script>
    <script src="collaboration.js"></script>

    <script>
      // Set up collaboration protection EARLY (before auth runs)
      window.isCollaborationProtected = function () {
        const isActive =
          localStorage.getItem("collaborationActive") === "true" ||
          localStorage.getItem("COLLABORATION_ACTIVE") === "true";
        const timestamp = localStorage.getItem("COLLABORATION_DATA_TIMESTAMP");
        const isRecent =
          !timestamp || Date.now() - parseInt(timestamp) < 24 * 60 * 60 * 1000;

        console.log(
          "[COLLAB] ðŸ›¡ï¸ Early protection check - Active:",
          isActive,
          "Recent:",
          isRecent
        );
        return isActive && isRecent;
      };

      // Simple, distributed initialization
      document.addEventListener("DOMContentLoaded", async function () {
        // Initialize collaboration module FIRST to ensure protection is active
        if (window.collaboration) {
          await window.collaboration.init();
        }

        // Initialize authentication SECOND to respect collaboration protection
        const session = await user.initAuth();

        // Initialize context with knowledge of auth state (loads data appropriately)
        await context.init(session);

        // Handle UI based on auth state
        await user.updateAuthState(session);

        // Initialize modules (they handle their own click handlers and UI)
        artifacts.init();
        views.init();

        // Note: collaboration.init() already called at the top
      });

      // Listen for URL hash changes to auto-join collaboration
      window.addEventListener("hashchange", async function () {
        console.log("[COLLAB] URL hash changed, checking for collaboration ID");
        if (window.collaboration) {
          await window.collaboration.checkForAutoJoin();
        }
      });
    </script>
  </body>
</html>
);
